  {% extends 'base.html' %}
  {% load static %}

  {% block 'cabecalho' %}
  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCj2Tn5LiWlTUgevFKlQ7aUku8ZxYyjyXM"></script>

  <!--  -->

  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  {% endblock %}
  {% block 'conteudo' %}

  <div>
    <ul class="nav nav-pills nav-pills-custom" id="tab-planejamento-acompanhamento" role="tablist" style="padding-bottom: 0px !important;">
      <li class="nav-item nav-planejamento-acompanhamento" role="presentation">
        <a class="nav-link active" id="pillColetas" data-bs-toggle="pill" href="#pillConteudoColetas" role="tab" aria-controls="pills-home" aria-selected="true">
          <span>Coletas</span>
        </a>
      </li>
      <li class="nav-item nav-planejamento-acompanhamento " role="presentation">
        <a class="nav-link" id="pillEntregas" data-bs-toggle="pill" href="#pillConteudoEntregas" role="tab" aria-controls="pills-profile" aria-selected="false" tabindex="-1">
          <span>Entregas</span>
        </a>
      </li>
      <li class="nav-item nav-planejamento-acompanhamento" role="presentation">
        <a class="nav-link" id="pills-contact-tab-custom" data-bs-toggle="pill" href="#pills-music" role="tab" aria-controls="pills-contact" aria-selected="false" tabindex="-1">
          Music
        </a>
      </li>
      <li class="nav-item nav-planejamento-acompanhamento" role="presentation">
        <a class="nav-link" id="pills-vibes-tab-custom" data-bs-toggle="pill" href="#pills-vibes" role="tab" aria-controls="pills-contact" aria-selected="false" tabindex="-1">
          Vibes
        </a>
      </li>
      <li class="nav-item nav-planejamento-acompanhamento" role="presentation">
        <a class="nav-link" id="pills-energy-tab-custom" data-bs-toggle="pill" href="#pills-energy" role="tab" aria-controls="pills-contact" aria-selected="false" tabindex="-1">
          Energy
        </a>
      </li>
    </ul>
    <div class="tab-content tab-content-custom-pill conteudo-pill-planejamento-acompanhamento" id="pills-tabContent-custom">
      <div class="tab-pane fade show active" id="pillConteudoColetas" role="tabpanel" aria-labelledby="pillColetas">
        {% include 'abaPredtc.html' %}
      </div>
      <div class="tab-pane fade" id="pillConteudoEntregas" role="tabpanel" aria-labelledby="pillEntregas">
        {% include 'mapasEntregas.html' %}
      </div>
      <div class="tab-pane fade" id="pills-music" role="tabpanel" aria-labelledby="pills-contact-tab-custom">
      </div>
      <div class="tab-pane fade" id="pills-vibes" role="tabpanel" aria-labelledby="pills-vibes-tab-custom">
      </div>
      <div class="tab-pane fade" id="pills-energy" role="tabpanel" aria-labelledby="pills-energy-tab-custom">
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="modalPlanejamentoColetas" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalColetaId">Modal title</h5>
          <button type="button" class="btn-close" onclick="closeModal()"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-sm-6" id="tabelaColetas">

            </div>
            <div class="col-sm-6" id="acoesColetas">

            </div>
            <div class="col-sm-12" id="botoesColetas">

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>



  <script>
      function initMap() {
        // Coordenadas iniciais
        let myLatLng = { lat: -23.47337308, lng: -46.47320867 };
        let myLatLngEntrega = { lat: -12.9704, lng: -38.5124 };
        let iconeVermelho = "{% static 'images/mapasIcones/pinVermelho.png' %}"
        let iconeAzul = "{% static 'images/mapasIcones/pinAzul.png' %}"
        let iconeRoxo = "{% static 'images/mapasIcones/pinRoxo.png' %}"
        let iconeVerde = "{% static 'images/mapasIcones/pinVerde.png' %}"
        let iconePreto = "{% static 'images/mapasIcones/pinPreto.png' %}"
        let armazem = "{% static 'images/mapasIcones/armazem.png' %}"
        let local = "{% static 'images/mapasIcones/loja.png' %}"

        var coordenadasGeradas = geraCoordenadas();
        var iconSize = {
          width: 30, // Largura desejada em pixels
          height: 30 // Altura desejada em pixels
        };



        // Cria um novo mapa do Google
        var map = new google.maps.Map(document.getElementById('map'), { 
            center: myLatLng,
            zoom: 10.3, // Ajuste o zoom conforme necessário
        });

        // Cria um novo mapa do Google
        var mapEntregas = new google.maps.Map(document.getElementById('mapEntregas'), {
          center: myLatLngEntrega,
          zoom: 10.3 // Ajuste o zoom conforme necessário
        });

        map.markers = [];

        const removeMarker = (markerId) => {
            // Verifica se map.markers está definido e possui elementos
            if (map.markers && map.markers.length > 0) {
                // Iterar sobre map.markers para encontrar o marcador
                for (let i = 0; i < map.markers.length; i++) {
                    if (map.markers[i].id === markerId) {
                        // Remove o marcador do mapa
                        map.markers[i].setMap(null);
                        // Remove o marcador da lista de marcadores
                        map.markers.splice(i, 1);
                        break;
                    }
                }
            }
        };        



        // let btn = document.getElementById("btnMudaTeste");
        // btn.addEventListener("click", () => {
        //   mudarLocalizacaoEZoom(-23.47337308, -46.47320867, 13);
        // });
        
      const addMarker = (latitude, longitude, icone, dados, id, callback) => {
          const marker = new google.maps.Marker({
              position: { lat: latitude, lng: longitude },
              map: map,
              icon: {
                  url: icone,
                  scaledSize: new google.maps.Size(iconSize.width, iconSize.height)
              },
              id: id // Atribui um ID único ao marcador
          });

          marker.addListener('click', () => {
              if (typeof callback === 'function') {
                  callback(dados);
              }
          });

          // Adiciona o marcador à lista de marcadores do mapa
          map.markers.push(marker);
      };

      function verificarLocalidadesNaRota(origem, destino, localidades) {
            var directionsService = new google.maps.DirectionsService();

            // Faz a solicitação para calcular a rota entre origem e destino
            directionsService.route({
                origin: origem,
                destination: destino,
                travelMode: google.maps.TravelMode.DRIVING
            }, function(result, status) {

                if (status === google.maps.DirectionsStatus.OK) {

                    // Obtém a rota da resposta
                    var route = result.routes[0];

                    // Itera sobre cada "perna" da rota
                    route.legs.forEach(function(leg) {
                        // Itera sobre cada passo da perna (segmento da rota)
                        leg.steps.forEach(function(step) {
                            // Itera sobre cada coordenada do passo
                            step.path.forEach(function(pathCoord) {
                                // Verifica se cada localidade está próxima o suficiente do caminho da rota
                                localidades.forEach(function(localidade) {
                                    var localidadeLatLng = new google.maps.LatLng(localidade[0], localidade[1]);
                                    var distancia = google.maps.geometry.spherical.computeDistanceBetween(pathCoord, localidadeLatLng);

                                    // Defina aqui uma distância máxima para considerar "na rota" (em metros)
                                    var distanciaMaxima = 5000; // Por exemplo, 100 metros

                                    if (distancia <= distanciaMaxima) {
                                        console.log('A localidade', localidade[3], 'está na rota.');
                                        // Aqui você pode adicionar sua lógica para lidar com a localidade na rota
                                    }
                                });
                            });
                        });
                    });
                } else {
                    console.error('Erro ao calcular rota:', status);
                }
            });
        }

// // Exemplo de uso:
// var origem = new google.maps.LatLng(-23.5505, -46.6333); // São Paulo
// var destino = new google.maps.LatLng(-23.5631, -46.6544); // Exemplo de destino
// var localidades = [
//     { lat: -23.5600, lng: -46.6400 }, // Localidade 1
//     { lat: -23.5550, lng: -46.6450 }, // Localidade 2
//     { lat: -23.5580, lng: -46.6380 }  // Localidade 3
// ];

// verificarLocalidadesNaRota(origem, destino, localidades);


      function calcularRota(origem, destino) {
          // Cria uma solicitação para o serviço de direções
          var directionsService = new google.maps.DirectionsService();
          var directionsRenderer = new google.maps.DirectionsRenderer();

          // Configura o renderer para exibir a rota no mapa
          directionsRenderer.setMap(map);

          // Define os pontos de origem e destino para a rota
          var request = {
              origin: origem,
              destination: destino,
              travelMode: google.maps.TravelMode.DRIVING // Modo de viagem (DRIVING para carro)
          };

          // Faz a solicitação para calcular a rota
          directionsService.route(request, function(result, status) {
              if (status == google.maps.DirectionsStatus.OK) {
                  // Exibe a rota no mapa usando o renderer
                  directionsRenderer.setDirections(result);
              } else {
                  // Trata o erro caso não seja possível calcular a rota
                  console.error('Erro ao calcular rota:', status);
              }
          });
      }


        // Função para mudar a localização e o zoom do mapa
        function mudarLocalizacaoEZoom(latitude, longitude, zoom) {

            // Exemplo de uso
            var origem = new google.maps.LatLng(myLatLng);
            var destino = new google.maps.LatLng(latitude, longitude);

            calcularRota(origem,destino)

            // Chama a função para calcular e exibir a rota no mapa
            verificarLocalidadesNaRota(origem, destino,coordenadasGeradas);

          // var novaPosicao = new google.maps.LatLng(latitude,longitude);
          // map.setCenter(novaPosicao);
          // map.setZoom(zoom);
        }

        const teste = (element) => {
          let elemento = document.getElementById(element+'')
          // Obtém o valor dos atributos data-lng e data-lat do elemento
          const lng = elemento.getAttribute('data-lng');
          const lat = elemento.getAttribute('data-lat');

          // Verifica se os valores foram encontrados e os exibe no console
          if (lng && lat) {
            mudarLocalizacaoEZoom(lat,lng,14)

          } else {
            console.log('Dados de longitude e/ou latitude não encontrados.');
          }
        };

        let botoes = {
                      mostrar: {
                        classe: "btn-primary text-white",
                        texto: '<i class="fa fa-eye" aria-hidden="true"></i>',
                        callback: teste
                      }
                    };

const mostrarInformacoesDetalhadas = (dados) => {
  const msgInfo = () => {
    let tabela = `
      <div class="row">
        <div class="col-sm-6">
          <table class="table table-striped table-sm" style="width:80%">
            <tr>
              <td style="text-align: left;"><strong>Número:</strong></td>
              <td style="text-align: left;">${dados[3]}</td>
            </tr>
            <tr>
              <td style="text-align: left;"><strong>Data:</strong></td>
              <td style="text-align: left;">17/10/2007</td>
            </tr>
            <tr>
              <td style="text-align: left;"><strong>Romaneio:</strong></td>
              <td style="text-align: left;">${dados[3]}</td>
            </tr>
            <tr>
              <td style="text-align: left;"><strong>Veículo:</strong></td>
              <td style="text-align: left;">${dados[5]}</td>
            </tr>
            <tr>
              <td style="text-align: left;"><strong>Motorista:</strong></td>
              <td style="text-align: left;">${dados[4]}</td>
            </tr>
            <tr>
              <td style="text-align: left;"><strong>Volumes:</strong></td>
              <td style="text-align: left;">${dados[7]}</td>
            </tr>
            <tr>
              <td style="text-align: left;"><strong>Peso:</strong></td>
              <td style="text-align: left;">${dados[8]}</td>
            </tr>
            <tr>
              <td style="text-align: left;"><strong>Localização:</strong></td>
              <td style="text-align: left;">${dados[6]}</td>
            </tr>
            <tr>
              <td style="text-align: left;"><strong>Status:</strong></td>
              <td style="text-align: left;">${dados[9]}</td>
            </tr>
          </table>
        </div> 
      </div>
    `;
    let acoes = `
                <b>Anexar ao Veículo</b>
                <div class="btn-group" role="group" aria-label="Basic example" style="width:100%">
                  <select class="form-select">
                    <option>Teste 1</option>
                    <option>Teste 2</option>
                  </select>
                  <button type="button" id="addDtcVeiculo" class="btn btn-primary">
                    <i class="fa fa-plus" aria-hidden="true"></i>
                  </button>
                </div>
                <b class="pt-2" >Inserir ocorrência</b>
                <div class="btn-group" role="group" aria-label="Basic example" style="width:100%">
                  <select class="form-select">
                    <option>Teste 1</option>
                    <option>Teste 2</option>
                  </select>
                  <button type="button" class="btn btn-primary">
                    <i class="fa fa-plus" aria-hidden="true"></i>
                  </button>
                </div>
                <div class="mt-2">
                  <b class="pt-2" >Prioridade</b>
                  <div class="badge badge-warning" style="width:100%">Média</div>
                </div>
                `
    
    let btnGerarIntinerarios = `
                <div class="btn-group pt-2" role="group" aria-label="Basic example" style="width:100%">
                  <button type="button" class="btn btn-success">
                    <i class="fa fa-location-arrow" aria-hidden="true"></i>
                    Criar itinerário daqui
                  </button>
                  
                  <button type="button" class="btn btn-primary">
                    <i class="fa fa-map-marker" aria-hidden="true"></i>
                    Criar itinerário até aqui
                  </button>
                </div> `
    let idColeta = `<span>Pré Dtc Nº : </span><span id="numDocumento"> ${dados[3]}</span>`
    let modalColetaId = document.getElementById("modalColetaId")
    let tabelaColetas = document.getElementById("tabelaColetas")
    let acoesColetas = document.getElementById("acoesColetas")
    let botoesColetas = document.getElementById("botoesColetas")
    tabelaColetas.innerHTML = tabela
    acoesColetas.innerHTML = acoes
    modalColetaId.innerHTML = idColeta
    botoesColetas.innerHTML = btnGerarIntinerarios

    const btnAddDtcVeiculo = document.getElementById("addDtcVeiculo");
    btnAddDtcVeiculo.addEventListener('click', () => {
        removeMarker(dados[3]); // Remove o marcador com base no ID específico
    });

    openModal('modalPlanejamentoColetas')
  };



  // Chama a função msgInfo
  msgInfo();


};





    let dadosTableColetas = []
    let dadosAdicionais = []
    addMarker(myLatLng.lat,myLatLng.lng,armazem)
    // Obtém as coordenadas geradas pela função geraCoordenadas
      // Adiciona marcadores para cada conjunto de coordenadas
      coordenadasGeradas.forEach(function(coordenadas) {
        switch (coordenadas[2]) {
          case 1:
            dadosTableColetas.push({id:coordenadas[3],status:'Em Rota',placa:coordenadas[5],dadosAdicionais:{lat:coordenadas[0],lng:coordenadas[1]}})
            addMarker(coordenadas[0],coordenadas[1],local,coordenadas,coordenadas[3],mostrarInformacoesDetalhadas)
            break;
          case 2:
            dadosTableColetas.push({id:coordenadas[3],status:'Em Trânsito',placa:coordenadas[5],dadosAdicionais:{lat:coordenadas[0],lng:coordenadas[1]}})
            addMarker(coordenadas[0],coordenadas[1],local,coordenadas,coordenadas[3],mostrarInformacoesDetalhadas)
            break;
          case 3:
            dadosTableColetas.push({id:coordenadas[3],status:'Concluída',placa:coordenadas[5],dadosAdicionais:{lat:coordenadas[0],lng:coordenadas[1]}})
            addMarker(coordenadas[0],coordenadas[1],local,coordenadas,coordenadas[3],mostrarInformacoesDetalhadas)
            break;  
          case 4: 
            dadosTableColetas.push({id:coordenadas[3],status:'Aguardando',placa:coordenadas[5],dadosAdicionais:{lat:coordenadas[0],lng:coordenadas[1]}})
            addMarker(coordenadas[0],coordenadas[1],local,coordenadas,coordenadas[3],mostrarInformacoesDetalhadas)
            break;                                       
          default:
            break;
        }
        dadosAdicionais.push({lat:coordenadas[0],lng:coordenadas[1]})
      });
      popula_tbody_paginacao('paginacaoPlanejamento',
                             'infoPlanejamentoColetas',
                             dadosTableColetas,
                             botoes,
                             1,
                             9999,
                             false,
                             dadosAdicionais
                            )
    }


    // Chame a função initMap quando a página for carregada
    google.maps.event.addDomListener(window, 'load', initMap);
  </script>

  {% endblock %}

  {% block js %} 
  {% endblock %}