  {% extends 'base.html' %}
  {% load static %}

  {% block 'cabecalho' %}
  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCj2Tn5LiWlTUgevFKlQ7aUku8ZxYyjyXM"></script>

  <!--  -->

  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  {% endblock %}
  {% block 'conteudo' %}

  <div>
    <ul class="nav nav-pills nav-pills-custom" id="tab-planejamento-acompanhamento" role="tablist" style="padding-bottom: 0px !important;">
      <li class="nav-item nav-planejamento-acompanhamento" role="presentation">
        <a class="nav-link active" id="pillColetas" data-bs-toggle="pill" href="#pillConteudoColetas" role="tab" aria-controls="pills-home" aria-selected="true">
          <span>Coletas</span>
        </a>
      </li>
      <li class="nav-item nav-planejamento-acompanhamento " role="presentation">
        <a class="nav-link" id="pillEntregas" data-bs-toggle="pill" href="#pillConteudoEntregas" role="tab" aria-controls="pills-profile" aria-selected="false" tabindex="-1">
          <span>Entregas</span>
        </a>
      </li>
      <li class="nav-item nav-planejamento-acompanhamento" role="presentation">
        <a class="nav-link" id="pills-contact-tab-custom" data-bs-toggle="pill" href="#pills-music" role="tab" aria-controls="pills-contact" aria-selected="false" tabindex="-1">
          Music
        </a>
      </li>
      <li class="nav-item nav-planejamento-acompanhamento" role="presentation">
        <a class="nav-link" id="pills-vibes-tab-custom" data-bs-toggle="pill" href="#pills-vibes" role="tab" aria-controls="pills-contact" aria-selected="false" tabindex="-1">
          Vibes
        </a>
      </li>
      <li class="nav-item nav-planejamento-acompanhamento" role="presentation">
        <a class="nav-link" id="pills-energy-tab-custom" data-bs-toggle="pill" href="#pills-energy" role="tab" aria-controls="pills-contact" aria-selected="false" tabindex="-1">
          Energy
        </a>
      </li>
    </ul>
    <div class="tab-content tab-content-custom-pill conteudo-pill-planejamento-acompanhamento" id="pills-tabContent-custom">
      <div class="tab-pane fade show active" id="pillConteudoColetas" role="tabpanel" aria-labelledby="pillColetas">
        {% include 'abaPredtc.html' %}
      </div>
      <div class="tab-pane fade" id="pillConteudoEntregas" role="tabpanel" aria-labelledby="pillEntregas">
        {% include 'mapasEntregas.html' %}
      </div>
      <div class="tab-pane fade" id="pills-music" role="tabpanel" aria-labelledby="pills-contact-tab-custom">
      </div>
      <div class="tab-pane fade" id="pills-vibes" role="tabpanel" aria-labelledby="pills-vibes-tab-custom">
      </div>
      <div class="tab-pane fade" id="pills-energy" role="tabpanel" aria-labelledby="pills-energy-tab-custom">
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="modalPlanejamentoColetas" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalColetaId">Modal title</h5>
          <button type="button" class="btn-close" onclick="closeModal()"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-sm-6" id="tabelaColetas">

            </div>
            <div class="col-sm-6" id="acoesColetas">

            </div>
            <div class="col-sm-12" id="botoesColetas">

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% block js %} 
    <script src="{% static 'js/meusJS/planejamentoAcompanhamento/gerarDados.js' %}"></script>
    <script src="{% static 'js/meusJS/planejamentoAcompanhamento/planejamentoAcompanhamento.js' %}"></script>
    <script src="{% static 'js/meusJS/planejamentoAcompanhamento/initMap.js' %}"></script>
    <script src="{% static 'js/meusJS/planejamentoAcompanhamento/quadTree.js' %}"></script>


  {% endblock %}
  <script>
      function initMap() {
        // Coordenadas iniciais
        let myLatLng = { lat: -23.47337308, lng: -46.47320867 };
        let myLatLngEntrega = { lat: -12.9704, lng: -38.5124 };

        let iconeVermelho = "{% static 'images/mapasIcones/pinVermelho.png' %}"
        let iconeAzul = "{% static 'images/mapasIcones/pinAzul.png' %}"
        let iconeRoxo = "{% static 'images/mapasIcones/pinRoxo.png' %}"
        let iconeVerde = "{% static 'images/mapasIcones/pinVerde.png' %}"
        let iconePreto = "{% static 'images/mapasIcones/pinPreto.png' %}"
        let armazem = "{% static 'images/mapasIcones/armazem.png' %}"
        let local = "{% static 'images/mapasIcones/loja.png' %}"

        const mostrarInformacoesDetalhadas = (dados) => {
          const msgInfo = () => {
            let tabela = `
              <div class="row">
                <div class="col-sm-6">
                  <table class="table table-striped table-sm" style="width:80%">
                    <tr>
                      <td style="text-align: left;"><strong>Número:</strong></td>
                      <td style="text-align: left;">${dados[3]}</td>
                    </tr>
                    <tr>
                      <td style="text-align: left;"><strong>Data:</strong></td>
                      <td style="text-align: left;">17/10/2007</td>
                    </tr>
                    <tr>
                      <td style="text-align: left;"><strong>Romaneio:</strong></td>
                      <td style="text-align: left;">${dados[3]}</td>
                    </tr>
                    <tr>
                      <td style="text-align: left;"><strong>Veículo:</strong></td>
                      <td style="text-align: left;">${dados[5]}</td>
                    </tr>
                    <tr>
                      <td style="text-align: left;"><strong>Motorista:</strong></td>
                      <td style="text-align: left;">${dados[4]}</td>
                    </tr>
                    <tr>
                      <td style="text-align: left;"><strong>Volumes:</strong></td>
                      <td style="text-align: left;">${dados[7]}</td>
                    </tr>
                    <tr>
                      <td style="text-align: left;"><strong>Peso:</strong></td>
                      <td style="text-align: left;">${dados[8]}</td>
                    </tr>
                    <tr>
                      <td style="text-align: left;"><strong>Localização:</strong></td>
                      <td style="text-align: left;">${dados[6]}</td>
                    </tr>
                    <tr>
                      <td style="text-align: left;"><strong>Status:</strong></td>
                      <td style="text-align: left;">${dados[9]}</td>
                    </tr>
                  </table>
                </div> 
              </div>
            `;
            let acoes = `
                        <b>Anexar ao Veículo</b>
                        <div class="btn-group" role="group" aria-label="Basic example" style="width:100%">
                          <select class="form-select">
                            <option>Teste 1</option>
                            <option>Teste 2</option>
                          </select>
                          <button type="button" id="addDtcVeiculo" class="btn btn-primary">
                            <i class="fa fa-plus" aria-hidden="true"></i>
                          </button>
                        </div>
                        <b class="pt-2" >Inserir ocorrência</b>
                        <div class="btn-group" role="group" aria-label="Basic example" style="width:100%">
                          <select class="form-select">
                            <option>Teste 1</option>
                            <option>Teste 2</option>
                          </select>
                          <button type="button" class="btn btn-primary">
                            <i class="fa fa-plus" aria-hidden="true"></i>
                          </button>
                        </div>
                        <div class="mt-2">
                          <b class="pt-2" >Prioridade</b>
                          <div class="badge badge-warning" style="width:100%">Média</div>
                        </div>
                        `
            
            let btnGerarIntinerarios = `
                        <div class="btn-group pt-2" role="group" aria-label="Basic example" style="width:100%">
                          <button type="button" class="btn btn-success">
                            <i class="fa fa-location-arrow" aria-hidden="true"></i>
                            Criar itinerário daqui
                          </button>
                          
                          <button type="button" class="btn btn-primary">
                            <i class="fa fa-map-marker" aria-hidden="true"></i>
                            Criar itinerário até aqui
                          </button>
                        </div> `
            let idColeta = `<span>Pré Dtc Nº : </span><span id="numDocumento"> ${dados[3]}</span>`
            let modalColetaId = document.getElementById("modalColetaId")
            let tabelaColetas = document.getElementById("tabelaColetas")
            let acoesColetas = document.getElementById("acoesColetas")
            let botoesColetas = document.getElementById("botoesColetas")
            tabelaColetas.innerHTML = tabela
            acoesColetas.innerHTML = acoes
            modalColetaId.innerHTML = idColeta
            botoesColetas.innerHTML = btnGerarIntinerarios

            const btnAddDtcVeiculo = document.getElementById("addDtcVeiculo");
            btnAddDtcVeiculo.addEventListener('click', () => {
                removeMarker(mapaColetas, dados[3]); // Passa a referência ao mapa e o ID do marcador
            });

            openModal('modalPlanejamentoColetas')
          };



          // Chama a função msgInfo
          msgInfo();


        };

        var coordenadasGeradas = geraCoordenadas();

        let mapaColetas = criaMapas('map', myLatLng);

        addMarkerResponsavel(myLatLng.lat,myLatLng.lng,armazem,{},0,mapaColetas)
        let marcadoresColetas = []
        const quadtree = new QuadTree(new Rectangle(0, 0, 1000, 1000), 4); // Defina os limites da quadtree e a capacidade máxima

        coordenadasGeradas.forEach(coordenada => {
          mapaColetas.dados.push({id:coordenada[3],status:'Em Rota',placa:coordenada[5],dadosAdicionais:{lat:coordenada[0],lng:coordenada[1]}})
          mapaColetas.markers.push(addMarker (coordenada[0], coordenada[1], local, coordenada, coordenada[3], mapaColetas,mostrarInformacoesDetalhadas))
          quadtree.insert({ x: coordenada[0], y:coordenada[1] });
        });

        // console.log(quadtree)

        const verificarLocalidadesNaRota = (origem, destino, mapa) => {
          const directionsService = new google.maps.DirectionsService();

          directionsService.route({
              origin: origem,
              destination: destino,
              travelMode: google.maps.TravelMode.DRIVING
          }, (result, status) => {
              if (status === google.maps.DirectionsStatus.OK) {
                  const routeCoordinates = [];

                  result.routes[0].legs.forEach((leg) => {
                      leg.steps.forEach((step) => {
                          step.path.forEach((pathCoord) => {
                              routeCoordinates.push(pathCoord);
                          });
                      });
                  });

                  // Consulta localidades próximas usando a QuadTree
                  routeCoordinates.forEach((routeCoord) => {
                      const proximidadeRange = new Rectangle(routeCoord.lat(), routeCoord.lng(), -46.825123,-23.356792); // Defina a área de consulta em torno do ponto da rota
                      const localidadesProximas = quadtree.queryRange(proximidadeRange);

                      console.log(localidadesProximas)

                      // Lógica para lidar com localidades próximas
                      localidadesProximas.forEach((localidade) => {
                          console.log('A localidade', localidade.id, 'está na rota.');
                          // Adicione sua lógica aqui para manipular as localidades na rota
                      });
                  });
              } else {
                  console.error('Erro ao calcular rota:', status);
              }
          });
      };

        // const verificarLocalidadesNaRota = (origem, destino, localidades, mapa) => {
        //     // Obter a rota entre origem e destino
        //     const directionsService = new google.maps.DirectionsService();
        //     directionsService.route({
        //         origin: origem,
        //         destination: destino,
        //         travelMode: google.maps.TravelMode.DRIVING
        //     }, (result, status) => {
        //         if (status === google.maps.DirectionsStatus.OK) {
        //             // Coletar todas as coordenadas da rota
        //             const routeCoordinates = [];
        //             result.routes[0].legs.forEach((leg) => {
        //                 leg.steps.forEach((step) => {
        //                     step.path.forEach((pathCoord) => {
        //                         routeCoordinates.push(pathCoord);
        //                     });
        //                 });
        //             });

        //             // Verificar cada localidade em relação à rota
        //             localidades.dados.forEach((localidade) => {
        //                 const localidadeLatLng = new google.maps.LatLng(localidade.dadosAdicionais.lat, localidade.dadosAdicionais.lng);

        //                 // Verificar se a localidade está próxima de algum ponto da rota
        //                 const isOnRoute = routeCoordinates.some((routeCoord) => {
        //                     const distancia = google.maps.geometry.spherical.computeDistanceBetween(routeCoord, localidadeLatLng);
        //                     const distanciaMaxima = 5000; // 5 km, por exemplo

        //                     return distancia <= distanciaMaxima;
        //                 });

        //                 if (isOnRoute) {
        //                     console.log('A localidade', localidade.id, 'está na rota.');
        //                     // removeMarker(mapa, localidade.id);
        //                     // Lógica adicional para lidar com a localidade na rota
        //                 }
        //             });
        //         } else {
        //             console.error('Erro ao calcular rota:', status);
        //         }
        //     });
        // };




      const calcularRota=(origem, destino,mapa)=> {

        // Cria uma solicitação para o serviço de direções
        var directionsService = new google.maps.DirectionsService();
        var directionsRenderer = new google.maps.DirectionsRenderer();

        // Define os pontos de origem e destino para a rota
        var request = {
            origin: origem,
            destination: destino,
            travelMode: google.maps.TravelMode.DRIVING // Modo de viagem (DRIVING para carro)
        };

        // Faz a solicitação para calcular a rota
        directionsService.route(request, function(result, status) {
            if (status == google.maps.DirectionsStatus.OK) {
              console.log(result)
                // Exibe a rota no mapa usando o renderer
                directionsRenderer.setDirections(result);
            } else {
                // Trata o erro caso não seja possível calcular a rota
                console.error('Erro ao calcular rota:', status);
            }
        });

      }



      // Função para mudar a localização e o zoom do mapa
      const mudarLocalizacaoEZoom=(latitude, longitude, zoom,mapa)=> {

          // Exemplo de uso
          var origem = new google.maps.LatLng(myLatLng);
          var destino = new google.maps.LatLng(latitude, longitude);


          // calcularRota(origem,destino,mapaColetas)

          // console.log(mapaColetas)

          verificarLocalidadesNaRota(origem,destino,mapaColetas)

          // Chama a função para calcular e exibir a rota no mapa
          // verificarLocalidadesNaRota(origem, destino,coordenadasGeradas);

        // var novaPosicao = new google.maps.LatLng(latitude,longitude);
        // mapa.setCenter(novaPosicao);
        // mapa.setZoom(zoom);
      }

      const teste = (element) => {
        let elemento = document.getElementById(element+'')
        // Obtém o valor dos atributos data-lng e data-lat do elemento
        const lng = elemento.getAttribute('data-lng');
        const lat = elemento.getAttribute('data-lat');

        // Verifica se os valores foram encontrados e os exibe no console
        if (lng && lat) {
          mudarLocalizacaoEZoom(lat,lng,14,mapaColetas)

        } else {
          console.error('Dados de longitude e/ou latitude não encontrados.');
        }
      };

      let botoes = {
                    mostrar: {
                      classe: "btn-primary text-white",
                      texto: '<i class="fa fa-eye" aria-hidden="true"></i>',
                      callback: teste
                    }
                  };




        // Cria um novo mapa do Google
        // var mapEntregas = new google.maps.Map(document.getElementById('mapEntregas'), {
        //   center: myLatLngEntrega,
        //   zoom: 10.3 // Ajuste o zoom conforme necessário
        // });



        // let btn = document.getElementById("btnMudaTeste");
        // btn.addEventListener("click", () => {
        //   mudarLocalizacaoEZoom(-23.47337308, -46.47320867, 13);
        // });




      popula_tbody_paginacao('paginacaoPlanejamento',
                             'infoPlanejamentoColetas',
                             mapaColetas.dados,
                             botoes,
                             1,
                             9999,
                             false,
                             mapaColetas.dados.dadosAdicionais
                            )
    }


    // Chame a função initMap quando a página for carregada
    // google.maps.event.addDomListener(window, 'load', initMap);
  </script>

  {% endblock %}

